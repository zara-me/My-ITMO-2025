-- Удаление таблиц, если они уже существуют
DROP TABLE IF EXISTS Н_СЕССИЯ CASCADE;
DROP TABLE IF EXISTS Н_ЛЮДИ CASCADE;

-- Создание таблицы Н_ЛЮДИ
CREATE TABLE Н_ЛЮДИ (
    ИД SERIAL PRIMARY KEY,
    ФАМИЛИЯ VARCHAR(100),
    ИМЯ VARCHAR(100),
    ОТЧЕСТВО VARCHAR(100),
    ИНН VARCHAR(20),
    ДАТА_РОЖДЕНИЯ DATE,
    МЕСТО_РОЖДЕНИЯ VARCHAR(255),
    ИНОСТРАН INT,
    ПОЛ CHAR(1),
    СТРАХ_НОМЕР VARCHAR(50),
    КОГДА_СОЗДАЛ TIMESTAMP,
    КТО_ИЗМЕНИЛ VARCHAR(100),
    КОГДА_ИЗМЕНИЛ TIMESTAMP,
    ДАТА_СМЕРТИ DATE
);

-- Создание таблицы Н_СЕССИЯ
CREATE TABLE Н_СЕССИЯ (
    ИД SERIAL PRIMARY KEY,
    СЕСС_ИД INT,
    ЧЛВК_ИД INT REFERENCES Н_ЛЮДИ(ИД),
    ВРЕМЯ TIMESTAMP,
    АУДИТОРИЯ INT,
    ДАТА_K DATE,
    ВРЕМЯ_K TIME,
    АУДИТОРИЯ_K INT,
    УЧГОД VARCHAR(20),
    ГРУППА INT,
    СЕМЕСТР INT,
    КТО_СОЗДАЛ VARCHAR(100),
    КТО_ИЗМЕНИЛ VARCHAR(100),
    КОГДА_ИЗМЕНИЛ TIMESTAMP,
    СМЕНА INT
);

-- Вставка данных в Н_ЛЮДИ
INSERT INTO Н_ЛЮДИ (
  ФАМИЛИЯ, ИМЯ, ОТЧЕСТВО, ИНН, ДАТА_РОЖДЕНИЯ,
  МЕСТО_РОЖДЕНИЯ, ИНОСТРАН, ПОЛ, СТРАХ_НОМЕР,
  КОГДА_СОЗДАЛ, КТО_ИЗМЕНИЛ, КОГДА_ИЗМЕНИЛ, ДАТА_СМЕРТИ
) VALUES
  ('Александров', 'Иван', 'Иванович', '1111111111', '1990-01-01', 'Москва', 0, 'М', '123-456-789', now(), 'admin', now(), NULL),
  ('Борисов',     'Петр', 'Сергеевич', '2222222222', '1991-02-02', 'Казань', 0, 'М', '234-567-890', now(), 'admin', now(), NULL),
  ('Иванов',      'Алексей', 'Дмитриевич', '3333333333', '1992-03-03', 'СПб', 0, 'М', '345-678-901', now(), 'admin', now(), NULL),
  ('Петров',      'Семен', 'Алексеевич', '4444444444', '1993-04-04', 'Томск', 0, 'М', '456-789-012', now(), 'admin', now(), NULL),
  ('Яковлев',     'Олег', 'Сергеевич', '5555555555', '1994-05-05', 'Иркутск', 0, 'М', '567-890-123', now(), 'admin', now(), NULL);

-- Вставка данных в Н_СЕССИЯ
INSERT INTO Н_СЕССИЯ (
  СЕСС_ИД, ЧЛВК_ИД, ВРЕМЯ, АУДИТОРИЯ, ДАТА_K, ВРЕМЯ_K,
  АУДИТОРИЯ_K, УЧГОД, ГРУППА, СЕМЕСТР, КТО_СОЗДАЛ,
  КТО_ИЗМЕНИЛ, КОГДА_ИЗМЕНИЛ, СМЕНА
) VALUES
  (101, 1, now(), 101, now(), '10:00', 201, '2009/2010', 101, 1, 'admin', 'admin', now(), 1),
  (102, 2, now(), 102, now(), '11:00', 202, '2010/2011', 101, 1, 'admin', 'admin', now(), 1),
  (103, 3, now(), 103, now(), '12:00', 203, '2011/2012', 101, 1, 'admin', 'admin', now(), 1),
  (104, 4, now(), 104, now(), '13:00', 204, '2007/2008', 101, 1, 'admin', 'admin', now(), 1),
  (105, 5, now(), 105, now(), '14:00', 205, '2012/2013', 101, 1, 'admin', 'admin', now(), 1);

SET enable_seqscan = OFF;

-- Индексы
CREATE INDEX idx_люди_фамилия ON Н_ЛЮДИ (ФАМИЛИЯ);
CREATE INDEX idx_сессия_учгод ON Н_СЕССИЯ(УЧГОД);
CREATE INDEX idx_сессия_члвк_ид ON Н_СЕССИЯ(ЧЛВК_ИД);

-- Запрос с анализом
EXPLAIN ANALYZE
SELECT Н_ЛЮДИ.ФАМИЛИЯ, Н_СЕССИЯ.УЧГОД
FROM Н_ЛЮДИ 
LEFT JOIN Н_СЕССИЯ ON Н_ЛЮДИ.ИД = Н_СЕССИЯ.ЧЛВК_ИД
WHERE Н_ЛЮДИ.ФАМИЛИЯ < 'Иванов'
AND Н_СЕССИЯ.УЧГОД > '2008/2009';
